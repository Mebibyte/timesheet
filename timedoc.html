<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8' />
    <title>Automatic Timesheet Creator</title>
    <link rel="stylesheet" type="text/css" href="timedoc.css">
  </head>
  <body>
    <div id="header">
      <p>Retrieves your hours using the Google Calendar API. Requires a separate calendar which contains your hours as events.</p>
    </div>
    <div id="selectCalendar" style="visibility: hidden">
      Select Calendar with TA hours:
      <select></select>
      <input type="submit" value="Select" onclick="handleSelectClick()">
    </div>
    <div id='upload' style="visibility: hidden">
      Upload to Google Drive: <input type="submit" value="upload" onClick="handleUploadClick()">
    </div>
    <div id="content"></div>
    <div id="authorize" style="visibility: hidden">Click to give access to view calendars and Google Drive: <button onclick="handleAuthClick()">Authorize</button></div>
    </body>
  <script type="text/javascript">
    var clientId = '704585586654-nn6d4t5a9le7g96mi7be2nirdf25ehf2.apps.googleusercontent.com';
    var scopes = 'https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/drive';

    // Authentication
    function handleClientLoad() {
      window.setTimeout(checkAuth,1);
    }

    function checkAuth() {
      gapi.auth.authorize({client_id: clientId, scope: scopes, immediate: true}, handleAuthResult);
    }

    function handleAuthResult(authResult) {
      var authorizeDiv = document.getElementById('authorize');
      if (authResult && !authResult.error) {
        authorizeDiv.style.visibility = 'hidden';
        makeApiCall();
      } else {
        authorizeDiv.style.visibility = '';
      }
    }

    function handleAuthClick(event) {
      gapi.auth.authorize({client_id: clientId, scope: scopes, immediate: false}, handleAuthResult);
      return false;
    }
    // END Authentication

    function handleSelectClick(event) {
      if (document.getElementById("selectCalendar").getElementsByTagName("select")[0].selectedIndex >= 0) {
        var today = new Date();
        var timesheet = new Date(2014, 9, 1);
        var timesheet1 = new Date(2014, 9, 2);
        while (timesheet1 < today) {
          timesheet.setDate(timesheet.getDate() + 14);
          timesheet1.setDate(timesheet1.getDate() + 14);
        }
        var start = new Date(timesheet);
        start.setDate(start.getDate() - 13);
        timesheet.setDate(timesheet.getDate() + 1);
        gapi.client.load('calendar', 'v3', function() {
          gapi.client.calendar.events.list({
                'calendarId': document.getElementById("selectCalendar").getElementsByTagName("select")[0].value,
                'timeMin': start.toISOString(),
                'timeMax': timesheet.toISOString(),
                'singleEvents': true,
                'orderBy': "startTime"
          }).execute(function(resp) {
            console.log(resp);
            var hoursString = '<div class="column">';
            var dayHours = 0;
            var weekHours = 0;
            var totalHours = 0;
            var events = "";
            var days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            for (i = 0; i < resp.items.length; i++) {
              var item = resp.items[i];
              while (new Date(item.start.dateTime).getDay() != start.getDay()) {
                hoursString += days[start.getDay()] + ": " + dayHours + "<br>";
                start.setDate(start.getDate() + 1);
                dayHours = 0;
                if (start.getDay() === 4) {
                  hoursString += "Total for week: " + weekHours + '</div><div class="column">';
                  weekHours = 0;
                }
              }
              var tempHours = ((new Date(item.end.dateTime) - new Date(item.start.dateTime)) / 3600000);
              dayHours += tempHours;
              weekHours += tempHours;
              totalHours += tempHours;
              events += resp.items[i].summary + " hours: " + tempHours + "<br>";
            }
            hoursString += days[start.getDay()] + ": " + dayHours + "<br>";
            hoursString += "Total for week: " + weekHours + "<br></div>";
            document.getElementById("content").innerHTML = "Hours for Timesheet:<br>" + hoursString + "<div style='clear: both'><br><br>Calendar Events:<br>" + events + '</div>';
            document.getElementById("upload").style.visibility = "";
          });
        });
      }
    }

    function fileLoaded(file) {
      console.log(file);
      gapi.client.load('drive', 'v2', function() {
        var mydata = {};
        mydata.title = "biweekly_test.xlsx";
        mydata.mimeType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
        mydata.description = "We are using insert to create a new file, but only the metadata.";

        var request = gapi.client.drive.files.insert(file, {'requestBody': mydata});

        request.execute(function(resp) { console.log(resp); });
      });
    }

    function getBinary(file){
      var xhr = new XMLHttpRequest();
      xhr.open("GET", file, false);
      xhr.overrideMimeType("text/plain; charset=x-user-defined");
      xhr.send(null);
      return xhr.responseText;
    }

    function base64Encode(str) {
      var CHARS = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";
      var out = "", i = 0, len = str.length, c1, c2, c3;
      while (i < len) {
        c1 = str.charCodeAt(i++) & 0xff;
        if (i == len) {
          out += CHARS.charAt(c1 >> 2);
          out += CHARS.charAt((c1 & 0x3) << 4);
          out += "==";
          break;
        }
        c2 = str.charCodeAt(i++);
        if (i == len) {
          out += CHARS.charAt(c1 >> 2);
          out += CHARS.charAt(((c1 & 0x3)<< 4) | ((c2 & 0xF0) >> 4));
          out += CHARS.charAt((c2 & 0xF) << 2);
          out += "=";
          break;
        }
        c3 = str.charCodeAt(i++);
        out += CHARS.charAt(c1 >> 2);
        out += CHARS.charAt(((c1 & 0x3) << 4) | ((c2 & 0xF0) >> 4));
        out += CHARS.charAt(((c2 & 0xF) << 2) | ((c3 & 0xC0) >> 6));
        out += CHARS.charAt(c3 & 0x3F);
      }
      return out;
    }

    /**
     * Insert new file.
     *
     * @param {File} fileData File object to read data from.
     * @param {Function} callback Function to call when the request is complete.
     */
    function insertFile(fileData, callback) {
      const boundary = '-------314159265358979323846';
      const delimiter = "\r\n--" + boundary + "\r\n";
      const close_delim = "\r\n--" + boundary + "--";

      var reader = new FileReader();
      reader.getBinary(fileData);
      reader.onload = function(e) {
        var contentType = fileData.type || 'application/octet-stream';
        var metadata = {
          'title': fileData.name,
          'mimeType': contentType
        };

        var base64Data = base64Encode(reader.result);
        var multipartRequestBody =
            delimiter +
            'Content-Type: application/json\r\n\r\n' +
            JSON.stringify(metadata) +
            delimiter +
            'Content-Type: ' + contentType + '\r\n' +
            'Content-Transfer-Encoding: base64\r\n' +
            '\r\n' +
            base64Data +
            close_delim;

        var request = gapi.client.request({
            'path': '/upload/drive/v2/files',
            'method': 'POST',
            'params': {'uploadType': 'multipart'},
            'headers': {
              'Content-Type': 'multipart/mixed; boundary="' + boundary + '"'
            },
            'body': multipartRequestBody});
        if (!callback) {
          callback = function(file) {
            console.log(file)
          };
        }
        request.execute(callback);
      }
    }

    function handleUploadClick() {
      var xmlhttp;
      if (window.XMLHttpRequest) { // code for IE7+, Firefox, Chrome, Opera, Safari
        xmlhttp = new XMLHttpRequest();
      } else { // code for IE6, IE5
        xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
      }
      xmlhttp.onreadystatechange = function() {
        if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
          insertFile(xmlhttp.responseText);
        }
      }
      xmlhttp.open("GET", "biweekly_timedoc.xlsx", true);
      xmlhttp.send();
    }

    // Load the API and make an API call.  Display the results on the screen.
    function makeApiCall() {
      gapi.client.load('calendar', 'v3', function() {
        var request = gapi.client.calendar.calendarList.list();
        request.execute(function(resp) {
          console.log(resp);
          var id = null;
          var selectDiv = document.getElementById("selectCalendar");
          var select = selectDiv.getElementsByTagName("select")[0];
          for (i = 0; i < resp.items.length; i++) {
            var option = document.createElement("option");
            option.text = resp.items[i].summary;
            option.value = resp.items[i].id;
            select.add(option);
          }
          selectDiv.style.visibility = '';
        });
      });
    }
  </script>
  <script src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>
</html>